<div class="calculation-container">
  <div class="calculation-card">
    <h2>Gram ve Fiyat Hesaplama</h2>
    
    <!-- Gold Price Info -->
    <div *ngIf="goldPrice" class="gold-price-info">
      <div class="price-header">
        <span class="price-label">ðŸ’° AltÄ±n Kuru:</span>
        <span class="price-value">{{ formatPrice(goldPrice.selling) }}/gram</span>
      </div>
    </div>
    
    <form [formGroup]="calculationForm" (ngSubmit)="calculate()" class="calculation-form">
      <!-- NEW: Product Type Selection -->
      <div class="form-group">
        <label for="productType">ÃœrÃ¼n Tipi</label>
        <select id="productType" formControlName="productType" class="form-control">
          <option *ngFor="let type of productTypes" [value]="type">{{ type }}</option>
        </select>
        <small class="form-help">
          <span *ngIf="isKolyeBilezik">Kolye/Bilezik iÃ§in uzunluk zorunludur</span>
          <span *ngIf="isYuzukKupe">YÃ¼zÃ¼k/KÃ¼pe iÃ§in uzunluk kullanÄ±lmaz</span>
        </small>
      </div>

      <div class="form-group">
        <label for="model">Model</label>
        <select id="model" formControlName="modelId" class="form-control">
          <option value="">SeÃ§iniz</option>
          <option *ngFor="let model of models" [value]="model.id">{{ model.modelTipi }}</option>
        </select>
      </div>

      <div class="form-group">
        <label for="ayar">Ayar</label>
        <select id="ayar" formControlName="ayar" class="form-control" [disabled]="ayars.length === 0">
          <option value="">SeÃ§iniz</option>
          <option *ngFor="let ayar of ayars" [value]="ayar">{{ ayar }} ayar</option>
        </select>
      </div>

      <!-- SÄ±ra - sadece Kolye/Bilezik iÃ§in -->
      <div class="form-group" *ngIf="isKolyeBilezik">
        <label for="sira">SÄ±ra <span class="required">*</span></label>
        <select id="sira" formControlName="sira" class="form-control" [disabled]="siras.length === 0">
          <option value="">SeÃ§iniz</option>
          <option *ngFor="let sira of siras" [value]="sira">{{ sira }}</option>
        </select>
      </div>

      <!-- Uzunluk field - only shown/required for Kolye/Bilezik -->
      <div class="form-group" *ngIf="isKolyeBilezik">
        <label for="uzunluk">Uzunluk (cm) <span class="required">*</span></label>
        <input 
          type="number" 
          id="uzunluk" 
          formControlName="uzunluk" 
          class="form-control" 
          placeholder="UzunluÄŸu giriniz (cm)"
          min="1"
          step="0.1"
        />
      </div>

      <div class="button-group">
        <button type="submit" class="btn btn-primary" [disabled]="!canCalculate || isLoadingPrice">
          {{ isLoadingPrice ? 'HesaplanÄ±yor...' : 'Fiyat Hesapla' }}
        </button>
        <button type="button" class="btn btn-secondary" (click)="reset()">
          Yeni Hesaplama
        </button>
      </div>
    </form>

    <div *ngIf="result" class="result-card">
      <h3>SonuÃ§</h3>
      <div class="result-summary">
        <div class="result-item">
          <span class="result-label">AÄŸÄ±rlÄ±k:</span>
          <span class="result-value">{{ result.gram }} gram</span>
        </div>
      </div>

      <!-- SatÄ±ÅŸ FiyatÄ± DetayÄ± -->
      <div *ngIf="result.fiyat" class="bozma-fiyati-section">
        <h4>SatÄ±ÅŸ FiyatÄ±</h4>
        <div class="bozma-table" style="display: flex; flex-wrap: wrap;">
          <div class="bozma-row">
            <span class="bozma-label">ÃœrÃ¼n GramÄ±:</span>
            <span class="bozma-value">{{ result.gram }} g</span>
          </div>
          <div class="bozma-row">
            <span class="bozma-label">Ayar:</span>
            <span class="bozma-value">{{ result.ayarKatsayisi || 0 }} ({{ calculationForm.get('ayar')?.value }})</span>
          </div>
          <div class="bozma-row" *ngIf="result.iscilik !== undefined">
            <span class="bozma-label">Ä°ÅŸÃ§ilik:</span>
            <span class="bozma-value">{{ result.iscilik / 1000 | number:'1.3-3' }}</span>
          </div>
          <div class="bozma-row" *ngIf="result.iscilik !== undefined">
            <span class="bozma-label">Toplam:</span>
            <span class="bozma-value">{{ (result.ayarKatsayisi || 0) + (result.iscilik / 1000) | number:'1.3-3' }}</span>
          </div>
          <div class="bozma-row">
            <span class="bozma-label">AltÄ±n Kuru:</span>
            <span class="bozma-value">{{ formatPrice(result.altinKuru || 0) }}/g</span>
          </div>
          <div class="bozma-row bozma-total">
            <span class="bozma-label">SatÄ±ÅŸ FiyatÄ±:</span>
            <span class="bozma-value price">{{ formatPrice(result.fiyat) }}</span>
          </div>
        </div>
      </div>

      <!-- Bozma FiyatÄ± Table -->
      <div *ngIf="result.bozmaFiyati" class="bozma-fiyati-section">
        <h4>Bozma FiyatÄ±</h4>
        <div class="bozma-table" style="display: flex; flex-wrap: wrap;">
          <div class="bozma-row">
            <span class="bozma-label">ÃœrÃ¼n GramÄ±:</span>
            <span class="bozma-value">{{ result.gram }} g</span>
          </div>
          <div class="bozma-row">
            <span class="bozma-label">Ayar:</span>
            <span class="bozma-value">{{ result.ayarKatsayisi || 0 }} ({{ calculationForm.get('ayar')?.value }})</span>
          </div>
          <div class="bozma-row">
            <span class="bozma-label">AlÄ±ÅŸ Kuru:</span>
            <span class="bozma-value">{{ formatPrice(result.altinAlisKuru || 0) }}/g</span>
          </div>
          <div class="bozma-row bozma-total">
            <span class="bozma-label">Bozma FiyatÄ±:</span>
            <span class="bozma-value price">{{ formatPrice(result.bozmaFiyati) }}</span>
          </div>
        </div>
      </div>

      <!-- Save as Order Button -->
      <div class="order-actions">
        <button type="button" class="btn btn-success" (click)="openOrderModal()">
          ðŸ“‹ SipariÅŸe Ekle
        </button>
      </div>
    </div>
  </div>

  <!-- Order Modal -->
  <div *ngIf="showOrderModal" class="modal-overlay" (click)="closeOrderModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>MÃ¼ÅŸteri SeÃ§</h3>
        <button class="btn-close" (click)="closeOrderModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="customer">MÃ¼ÅŸteri</label>
          <select id="customer" [formControl]="customerControl" class="form-control">
            <option value="">MÃ¼ÅŸteri seÃ§iniz</option>
            <option *ngFor="let customer of customers" [value]="customer.id">
              {{ customer.firstName }} {{ customer.lastName }} - {{ customer.phone }}
            </option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeOrderModal()">Ä°ptal</button>
        <button 
          class="btn btn-primary" 
          (click)="saveAsOrder()" 
          [disabled]="!customerControl.value || isSavingOrder"
        >
          {{ isSavingOrder ? 'Kaydediliyor...' : 'Kaydet' }}
        </button>
      </div>
    </div>
  </div>

  <div class="history-card" *ngIf="history.length > 0">
    <h3>Son Hesaplamalar</h3>
    <table class="history-table">
      <thead>
        <tr>
          <th>Tip</th>
          <th>Model</th>
          <th>Ayar</th>
          <th>SÄ±ra</th>
          <th>Uzunluk</th>
          <th>Gram</th>
          <th>Fiyat</th>
          <th>Tarih</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let item of history">
          <td>{{ item.productType }}</td>
          <td>{{ item.modelTipi }}</td>
          <td>{{ item.ayar }}</td>
          <td>{{ item.sira || '-' }}</td>
          <td>{{ item.uzunluk ? (item.uzunluk + ' cm') : '-' }}</td>
          <td>{{ item.sonuc }} g</td>
          <td>
            <span *ngIf="item.fiyat; else noPrice">{{ formatPrice(item.fiyat) }}</span>
            <ng-template #noPrice>-</ng-template>
          </td>
          <td>{{ formatDate(item.calculatedAt) }}</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
